<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroop Test å°ˆæ³¨åŠ›æ¸¬é©—</title>
    <style>
        /* åŸºæœ¬æ¨£å¼ */
        body { 
            font-family: 'Microsoft JhengHei', sans-serif; 
            text-align: center; 
            transition: background-color 0.1s;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }

        #word, #testWord { 
            font-size: 5em; 
            margin: 20px; 
            color: white; 
            font-weight: bold; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        /* å®Œå…¨éš±è—è¨ˆåˆ†æ¿ */
        #scoreboard { 
            display: none !important;
            visibility: hidden;
            position: absolute;
            left: -9999px;
        }

        #gameSection, #formSection, #resultSection, #testSection, #breakSection { 
            display: none; 
        }

        .inline-buttons { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin-top: 30px;
        }

        .center-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 80vh; 
            flex-direction: column; 
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group {
            margin: 20px 0;
            text-align: left;
            width: 350px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            color: #333;
            background-color: white;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5em;
        }

        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        select:hover {
            border-color: #3498db;
        }

        select.error {
            border-color: #e74c3c;
            background-color: #fff8f8;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
            padding: 5px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            color: #333;
            background-color: white;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-input.error {
            border-color: #e74c3c;
            background-color: #fff8f8;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            /* ç§»é™¤èƒŒæ™¯è‰²è®ŠåŒ– */
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* éŠæˆ²æŒ‰éˆ•æ¨£å¼ - æ›´å¤§çš„O/X */
        .game-button {
            background-color: #A0A0A0;
            color: white;
            font-size: 112px; /* 160pxçš„70% */
            padding: 40px 80px;
            margin: 0 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 160px;
            height: 160px;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }

        .game-button:hover {
            background-color: #888888;
            transform: translateY(-2px);
        }

        /* ä¿®æ”¹é€²åº¦æ¢æ¨£å¼ */
        .progress-bar {
            width: 300px;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin: 20px auto;  /* æ”¹ç‚º auto å¯¦ç¾ç½®ä¸­ */
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }

        /* åé¥‹è¨Šæ¯æ¨£å¼ */
        .test-feedback {
            padding: 10px 20px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .feedback-correct {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback-wrong {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ä¼‘æ¯å€å¡Šæ¨£å¼ */
        .break-info {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* çµæœå€å¡Šæ¨£å¼ */
        .result-info {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: left;
        }

        .round-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid #4CAF50;
        }

        /* æ›´æ–°éŸ³é »æ§åˆ¶æ¨£å¼ */
        .audio-control {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        /* é–‹å§‹æŒ‰éˆ•ç½®ä¸­ */
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            padding: 20px 40px;
        }

        /* è‰²å½©è¾¨è­˜æ¸¬é©—æ¨£å¼ */
        .color-test {
            display: none;
            text-align: center;
        }

        .color-button {
            font-size: 24px;
            margin: 10px;
            padding: 15px 30px;
        }

        /* è‰²å¡Šæ¨£å¼ */
        .color-block {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            margin: 10px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* éŠæˆ²èªªæ˜æ¨£å¼æ›´æ–° */
        .instruction-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 20px auto;
        }

        .instruction-content ul {
            text-align: left;
            padding-left: 20px;
        }

        .instruction-content li {
            margin: 15px 0;
            position: relative;
            padding-left: 25px;
        }

        .instruction-content li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #4CAF50;
        }

        .prep-timer {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: inline-block;
        }

        /* è‰²å½©è¾¨è­˜æ¸¬é©—æ¨£å¼æ›´æ–° */
        .color-answer-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 400px;
            margin: 30px auto;
        }

        .color-answer-button {
            font-size: 24px;
            padding: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-answer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* æ–°å¢é¡è‰²æŒ‰éˆ•æ¨£å¼ */
        .btn-red { background-color: #D98880; }
        .btn-blue { background-color: #85C1E9; }
        .btn-green { background-color: #A9DFBF; }
        .btn-yellow { background-color: #F7DC6F; }

        /* æ–°å¢æ¨£å¼ */
        .welcome-content, .instructions-content {
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            line-height: 1.6;
            padding: 20px;
        }

        .section-block {
            margin: 25px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .highlight {
            font-size: 1.2em;
            color: #2c3e50;
            font-weight: bold;
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .privacy-notice {
            color: #666;
            font-style: italic;
            margin-bottom: 20px;
        }

        .next-button {
            margin: 20px auto;
            display: block;
        }
    </style>
</head>

<body>
    <h1>Stroop Test å°ˆæ³¨åŠ›æ¸¬é©—</h1>
    
    <button id="startButton" onclick="showForm()">é–‹å§‹æ¸¬è©¦</button>

    <!-- ä¿®æ”¹æ­¡è¿é é¢å…§å®¹ -->
    <div id="welcomeSection" class="center-container">
        <h1>ğŸ¯ æ­¡è¿åƒåŠ ã€ŠéŸ³æ¨‚èˆ‡å°ˆæ³¨åŠ›æ¸¬é©—ã€‹</h1>
        <div class="welcome-content">
            <p>å¤§å®¶å¥½ï¼Œæˆ‘å€‘æ˜¯è‡ºç£å¸«ç¯„å¤§å­¸éŸ³æ¨‚ç³»çš„åŒå­¸ï¼</p>
            <p>ç”±æ–¼èª²å ‚ä½œæ¥­éœ€æ±‚ï¼Œ</p>
            <p>æˆ‘å€‘æ­£åœ¨æ¢è¨èƒŒæ™¯éŸ³æ¨‚å°æ–¼äººå€‘å°ˆæ³¨åŠ›çš„å½±éŸ¿ï¼Œ</p>
            <p>æ–¼æ˜¯é–‹å•Ÿäº†ä¸€å€‹å°ç ”ç©¶ã€‚å¸Œæœ›å¤§å®¶èƒ½å¡«ç­”ä»¥ä¸‹å•é¡ŒåŠé«”é©—å°éŠæˆ²ï¼ˆè¨˜å¾—æ‰“é–‹è²éŸ³å–”ğŸ”Šï¼‰ï¼Œè¬è¬ğŸ™</p>
            <button onclick="showInstructions()" class="next-button">ä¸‹ä¸€é </button>
        </div>
    </div>

    <!-- æ›´æ–°èªªæ˜é é¢ç¬¦è™Ÿ -->
    <div id="instructionsSection" class="center-container" style="display: none;">
        <h2>ğŸ§ª æ¸¬é©—æ–¹å¼èªªæ˜</h2>
        <div class="instructions-content">
            <p>é€™æ˜¯ä¸€å€‹æ ¹æ“šã€ŒStroop Effectï¼ˆå²æ¥šæ™®æ•ˆæ‡‰ï¼‰ã€è¨­è¨ˆçš„ç¶²é éŠæˆ²ã€‚</p>
            <p>ç•«é¢ä¸­æœƒå‡ºç¾ä¸€å€‹ä¸­æ–‡å­—ï¼ˆå¦‚ã€Œç´…ã€ã€Œç¶ ã€ã€Œè—ã€ç­‰ï¼‰æ­é…ä¸€ç¨®èƒŒæ™¯é¡è‰²ï¼Œ<br>æ‚¨çš„ä»»å‹™æ˜¯åˆ¤æ–·ï¼š</p>
            <p class="highlight">æ–‡å­—çš„æ„æ€ æ˜¯å¦èˆ‡ é¡è‰²èƒŒæ™¯ ç›¸ç¬¦ï¼Ÿ</p>
            <p>ä¸¦åœ¨1ç§’å…§é»é¸ã€ŒOã€æˆ–ã€ŒXã€ä½œç­”ã€‚</p>
            
            <div class="section-block">
                <h3>ğŸ§ æ¸¬é©—åŒ…å«å››å€‹ä¸åŒèƒŒæ™¯éŸ³æ¨‚æƒ…å¢ƒï¼š</h3>
                <ul>
                    <li>ç„¡éŸ³æ¨‚</li>
                    <li>å¤å…¸éŸ³æ¨‚ï¼ˆMozartï¼‰</li>
                    <li>çˆµå£«éŸ³æ¨‚ï¼ˆMiles Davisï¼‰</li>
                    <li>ç¨ç«‹éŸ³æ¨‚ï¼ˆDeftonesï¼‰</li>
                </ul>
            </div>
            
            <p>â€¢ æ¯ä¸€é—œé€²è¡Œ 20 ç§’ï¼Œæ¯é—œä¹‹é–“æœƒæœ‰ 15 ç§’ä¼‘æ¯æ™‚é–“<br>
               â€¢ ç³»çµ±æœƒéš¨æ©Ÿæ’­æ”¾éŸ³æ¨‚æƒ…å¢ƒï¼Œæ¯ç§’å‡ºç¾ä¸€é“é¡Œç›®<br>
               â€¢ è«‹ç›¡é‡æº–ç¢ºã€å¿«é€Ÿåœ°ä½œç­”ï¼</p>
            
            <button onclick="startTest()" class="next-button">é–‹å§‹æ¸¬é©—</button>
        </div>
    </div>

    <!-- æ›´æ–°è‰²å½©è¾¨è­˜æ¸¬é©—å€å¡Š -->
    <div id="colorTest" class="center-container" style="display: none;">
        <h2>è‰²å½©è¾¨è­˜æ¸¬é©—</h2>
        <p>è«‹é¸æ“‡èˆ‡æ–‡å­—ç›¸ç¬¦çš„é¡è‰²æŒ‰éˆ•ï¼š</p>
        <div id="colorTestWord" style="font-size: 5em; margin: 30px; font-weight: bold; color: black;">ç´…</div>
        <div class="color-answer-buttons">
            <button class="color-answer-button btn-red" onclick="checkColorAnswer('red')"></button>
            <button class="color-answer-button btn-blue" onclick="checkColorAnswer('blue')"></button>
            <button class="color-answer-button btn-green" onclick="checkColorAnswer('green')"></button>
            <button class="color-answer-button btn-yellow" onclick="checkColorAnswer('yellow')"></button>
        </div>
        <p id="colorTestFeedback"></p>
        <div class="progress-bar">
            <div class="progress" style="width: 0%"></div>
        </div>
    </div>

    <!-- è¡¨å–®å€å¡Š -->
    <div id="formSection" class="center-container" style="display: none;">
        <h2 class="form-title">åŸºæœ¬è³‡æ–™å¡«å¯«</h2>
        <p class="privacy-notice">æ‚¨æ‰€æä¾›çš„è³‡æ–™åƒ…ä¾›ç ”ç©¶ä½¿ç”¨ï¼Œä¸æœƒæ­éœ²å€‹äººèº«ä»½ï¼Œè«‹æ”¾å¿ƒå¡«å¯«ã€‚</p>
        
        <div class="form-group">
            <label for="name">å§“å:</label>
            <input type="text" id="name" class="form-input">
            <div class="error-message">è«‹è¼¸å…¥å§“å</div>
        </div>

        <div class="form-group">
            <label for="musicMajor">ç³»ç´š:</label>
            <select id="musicMajor">
                <option value="">--è«‹é¸æ“‡--</option>
                <option value="music">éŸ³æ¨‚ç³»</option>
                <option value="non-music">ééŸ³æ¨‚ç³»</option>
            </select>
            <div class="error-message">è«‹é¸æ“‡æ‚¨çš„ç§‘ç³»é¡åˆ¥</div>
        </div>

        <div class="form-group">
            <label for="grade">å­¸åˆ¶:</label>
            <select id="grade">
                <option value="">--è«‹é¸æ“‡--</option>
                <option value="undergraduate">å¤§å­¸ç”Ÿ</option>
                <option value="graduate">ç ”ç©¶ç”Ÿ</option>
            </select>
            <div class="error-message">è«‹é¸æ“‡æ‚¨çš„å­¸åˆ¶</div>
        </div>

        <div class="form-group">
            <label for="musicListeningHabit">å·¥ä½œ/è®€æ›¸æ™‚è†è½éŸ³æ¨‚ç¿’æ…£:</label>
            <select id="musicListeningHabit">
                <option value="">--è«‹é¸æ“‡--</option>
                <option value="always">ç¸½æ˜¯</option>
                <option value="often">ç¶“å¸¸</option>
                <option value="sometimes">å¶çˆ¾</option>
                <option value="rarely">å¾ˆå°‘</option>
                <option value="never">ç„¡</option>
            </select>
            <div class="error-message">è«‹é¸æ“‡æ‚¨çš„è†è½éŸ³æ¨‚ç¿’æ…£</div>
        </div>

        <button onclick="submitForm()">ä¸‹ä¸€æ­¥</button>
    </div>

    <!-- æ¸¬è©¦å€å¡Š -->
    <div id="testSection" class="center-container">
        <h2>æ¸¬è©¦éšæ®µ</h2>
        <div class="progress-bar">
            <div class="progress" style="width: 0%"></div>
        </div>
        <p>è«‹åˆ¤æ–·æ–‡å­—èˆ‡èƒŒæ™¯é¡è‰²æ˜¯å¦åŒ¹é…</p>
        <div id="testContainer">
            <div id="testWord">é¡è‰²</div>
            <div class="inline-buttons">
                <button class="game-button" onclick="checkTestAnswer(true)">O</button>
                <button class="game-button" onclick="checkTestAnswer(false)">X</button>
            </div>
        </div>
        <p id="testFeedback"></p>
        <button id="startGameButton" style="display:none;" onclick="startGame()">é€²å…¥éŠæˆ²</button>
    </div>

    <!-- éŠæˆ²èªªæ˜é é¢ -->
    <div id="instructionSection" class="center-container" style="display: none;">
        <h2>éŠæˆ²èªªæ˜</h2>
        <div class="instruction-content">
            <p>éŠæˆ²è¦å‰‡ï¼š</p>
            <ul>
                <li>æ¯å›åˆå…±æœ‰20é¡Œï¼Œæ¯é¡Œé¡¯ç¤º1ç§’</li>
                <li>è‹¥é¡Œç›®æ–‡å­—é¡è‰²èˆ‡èƒŒæ™¯é¡è‰²ç›¸ç¬¦ï¼Œè«‹æŒ‰ O</li>
                <li>è‹¥é¡Œç›®æ–‡å­—é¡è‰²èˆ‡èƒŒæ™¯é¡è‰²ä¸ç›¸ç¬¦ï¼Œè«‹æŒ‰ X</li>
                <li>æ¯å€‹é¡è‰²æœƒå‡ºç¾5æ¬¡</li>
                <li>ç­”é¡Œæ™‚é–“ç‚º20ç§’</li>
                <li>æ¯å›åˆé–“ä¼‘æ¯æ™‚é–“ç‚º15ç§’</li>
            </ul>
            <div class="prep-timer">
                æº–å‚™æ™‚é–“ï¼š<span id="prepTimer">15</span> ç§’
            </div>
        </div>
        <button onclick="startGameAfterPrep()" style="display: none;" id="startAfterPrepButton">é–‹å§‹éŠæˆ²</button>
    </div>

    <!-- éŠæˆ²å€å¡Š -->
    <div id="gameSection" class="center-container">
        <div id="word">é¡è‰²</div>
        <div class="inline-buttons">
            <button class="game-button" onclick="checkAnswer(true)">O</button>
            <button class="game-button" onclick="checkAnswer(false)">X</button>
        </div>
        <div id="scoreboard">
            <p>æ­£ç¢ºæ•¸é‡: <span id="correct">0</span></p>
            <p>éŒ¯èª¤æ•¸é‡: <span id="wrong">0</span></p>
            <p>å‰©é¤˜æ™‚é–“: <span id="timer">30</span> ç§’</p>
        </div>
    </div>

    <!-- ä¿®æ”¹ä¼‘æ¯å€å¡Š -->
    <div id="breakSection" class="center-container">
        <h2>ä¼‘æ¯æ™‚é–“</h2>
        <div class="break-info">
            <p>æœ¬å›åˆæ¸¬è©¦çµæœï¼š</p>
            <p>æ­£ç¢º: <span id="break-correct">0</span> æ¬¡</p>
            <p>éŒ¯èª¤: <span id="break-wrong">0</span> æ¬¡</p>
            <p>15ç§’å¾Œå°‡è‡ªå‹•é€²å…¥ä¸‹ä¸€å›åˆï¼Œè«‹ä¿æŒå°ˆæ³¨ã€‚</p>
            <p>å›åˆé–“çš„ä¼‘æ¯æ™‚é–“ç¢ºä¿æ¯ä½åƒèˆ‡è€…è½åˆ°ç›¸åŒæ®µè½çš„éŸ³æ¨‚ã€‚</p>
            <p>ä¼‘æ¯å‰©é¤˜æ™‚é–“ï¼š<span id="break-timer">15</span> ç§’</p>
        </div>
    </div>

    <!-- ä¿®æ”¹çµæœå€å¡Šä¸­çš„æœ€ä½³å›åˆé¡¯ç¤º -->
    <div id="resultSection" class="center-container">
        <h2>æ¸¬è©¦çµæœ</h2>
        <div class="result-info">
            <p id="roundResults"></p>
            <p>æœ€ä½³å›åˆ: <span id="bestRound">å¤å…¸éŸ³æ¨‚</span> å›åˆ</p>
        </div>
        <button onclick="restartGame()">é‡æ–°é–‹å§‹</button>
    </div>

    <script>
        let words = ["ç´…", "è—", "ç¶ ", "é»ƒ"];
        let colors = ["#D98880", "#85C1E9", "#A9DFBF", "#F7DC6F"];
        let testRound = 0;
        let gameRound = 0;
        let timer;
        let roundResults = [];
        let musicPreference = '';
        let currentColorTest = 0;
        let colorTestSequence = ['red', 'blue', 'green', 'yellow'];
        let questionQueue = [];
        let currentQuestion = 0;

        // éŸ³æ¨‚æ’­æ”¾é †åºè¨­å®š
        const musicSequences = {
            'always': ['jazz', 'classical', 'none', 'indie'],
            'often': ['classical', 'jazz', 'none', 'indie'],
            'sometimes': ['indie', 'jazz', 'none', 'classical'],
            'rarely': ['indie', 'classical', 'none', 'jazz'],
            'never': ['classical', 'indie', 'none', 'jazz']
        };

        // éŸ³æ¨‚è³‡æ–™è¨­å®š
        const musicData = {
            'jazz': {
                url: 'jazz.mp3'
            },
            'classical': {
                url: 'classical.mp3'
            },
            'indie': {
                url: 'indie.mp3'
            }
        };

        let audioPlayers = {};

        // é åŠ è¼‰éŸ³æ¨‚
        function preloadMusic() {
            for (const [type, data] of Object.entries(musicData)) {
                audioPlayers[type] = new Audio(data.url);
                audioPlayers[type].load();
                audioPlayers[type].loop = true;
            }
        }

        // æ’­æ”¾éŸ³æ¨‚
        function playMusic(musicType) {
            // åœæ­¢æ‰€æœ‰å…¶ä»–éŸ³æ¨‚
            Object.values(audioPlayers).forEach(player => {
                player.pause();
                player.currentTime = 0;
            });
            
            if (musicType === 'none') return;
            
            const player = audioPlayers[musicType];
            if (player) {
                player.currentTime = 0; // å¾é ­é–‹å§‹æ’­æ”¾
                player.volume = 0.5; // è¨­å®šéŸ³é‡ç‚º 50%
                try {
                    const playPromise = player.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log('æ’­æ”¾å¤±æ•—:', error);
                        });
                    }
                } catch (error) {
                    console.log('æ’­æ”¾å‡ºéŒ¯:', error);
                }
            }
        }

        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        function showForm() {
            document.getElementById("startButton").style.display = "none";
            document.getElementById("formSection").style.display = "block";
        }

        function submitForm() {
            const formFields = [
                { id: "name", label: "å§“å" },
                { id: "musicMajor", label: "ç³»ç´š" },
                { id: "grade", label: "å­¸åˆ¶" },
                { id: "musicListeningHabit", label: "å·¥ä½œ/è®€æ›¸æ™‚è†è½éŸ³æ¨‚ç¿’æ…£" }
            ];

            let isValid = true;

            formFields.forEach(item => {
                const element = document.getElementById(item.id);
                const errorMessage = element.nextElementSibling;
                
                if (!element.value) {
                    isValid = false;
                    element.classList.add('error');
                    errorMessage.style.display = 'block';
                } else {
                    element.classList.remove('error');
                    errorMessage.style.display = 'none';
                }
            });

            if (!isValid) return;

            // ç§»é™¤éŸ³æ¨‚æ’­æ”¾
            const musicHabit = document.getElementById("musicListeningHabit").value;
            currentMusicSequence = [...musicSequences[musicHabit]];
            
            document.getElementById("formSection").style.display = "none";
            document.getElementById("colorTest").style.display = "block";
            currentColorQuestion = 0;
            showNextColorQuestion();
        }

        // æ›´æ–°è‰²å½©è¾¨è­˜æ¸¬é©—ç›¸é—œå‡½æ•¸
        let colorTestWords = ["ç´…", "è—", "ç¶ ", "é»ƒ"];
        let currentColorQuestion = 0;

        function showNextColorQuestion() {
            const word = colorTestWords[currentColorQuestion];
            const testWord = document.getElementById("colorTestWord");
            testWord.innerText = word;
            
            // æ›´æ–°é€²åº¦æ¢
            const progress = (currentColorQuestion / colorTestWords.length) * 100;
            document.querySelector('#colorTest .progress').style.width = `${progress}%`;
        }

        function checkColorAnswer(selectedColor) {
            const currentWord = colorTestWords[currentColorQuestion];
            const isCorrect = (
                (selectedColor === 'red' && currentWord === "ç´…") ||
                (selectedColor === 'blue' && currentWord === "è—") ||
                (selectedColor === 'green' && currentWord === "ç¶ ") ||
                (selectedColor === 'yellow' && currentWord === "é»ƒ")
            );

            const feedback = document.getElementById('colorTestFeedback');
            
            if (isCorrect) {
                feedback.innerText = "ç­”å°äº†ï¼";
                feedback.className = "test-feedback feedback-correct";
                currentColorQuestion++;
                
                if (currentColorQuestion >= colorTestWords.length) {
                    setTimeout(() => {
                        document.getElementById("colorTest").style.display = "none";
                        document.getElementById("testSection").style.display = "block";
                        showTestWord();
                    }, 1000);
                    return;
                }

                setTimeout(() => {
                    feedback.innerText = "";
                    showNextColorQuestion();
                }, 1000);
            } else {
                feedback.innerText = "ç­”éŒ¯äº†ï¼Œè«‹å†è©¦ä¸€æ¬¡";
                feedback.className = "test-feedback feedback-wrong";
            }
        }

        function showTestWord() {
            const progressBar = document.querySelector('.progress');
            const progressPercent = (testRound / 3) * 100;
            progressBar.style.width = `${progressPercent}%`;

            if (testRound >= 3) {
                document.getElementById("testFeedback").innerText = "æ¸¬è©¦å·²å®Œæˆ";
                document.getElementById("testFeedback").className = "test-feedback feedback-correct";
                document.getElementById("startGameButton").style.display = "block";
                return;
            }

            let wordIndex = getRandomInt(words.length);
            let colorIndex = getRandomInt(colors.length);
            
            if (testRound === 0) {
                wordIndex = colorIndex;
            } else if (testRound === 1) {
                wordIndex = (colorIndex + 1) % colors.length;
            }
            
            document.getElementById("testWord").innerText = words[wordIndex];
            document.body.style.backgroundColor = colors[colorIndex];
            document.getElementById("testWord").setAttribute("data-correct", wordIndex === colorIndex);
        }

        function checkTestAnswer(userChoice) {
            let correct = document.getElementById("testWord").getAttribute("data-correct") === "true";
            let feedback = document.getElementById("testFeedback");
            
            if (userChoice === correct) {
                feedback.innerText = "ç­”å°äº†ï¼";
                feedback.className = "test-feedback feedback-correct";
            } else {
                feedback.innerText = "ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯" + (correct ? "åŒ¹é…" : "ä¸åŒ¹é…");
                feedback.className = "test-feedback feedback-wrong";
            }

            testRound++;
            
            const progressBar = document.querySelector('.progress');
            const progressPercent = (testRound / 3) * 100;
            progressBar.style.width = `${progressPercent}%`;

            if (testRound < 3) {
                setTimeout(() => {
                    feedback.innerText = `æº–å‚™ç¬¬ ${testRound + 1} é¡Œ...`;
                    feedback.className = "test-feedback";
                    setTimeout(showTestWord, 1000);
                }, 1500);
            } else {
                setTimeout(() => {
                    feedback.innerText = "æ¸¬è©¦å®Œæˆï¼æ‚¨å¯ä»¥é–‹å§‹æ­£å¼éŠæˆ²äº†";
                    feedback.className = "test-feedback feedback-correct";
                    document.getElementById("startGameButton").style.display = "block";
                }, 1500);
            }
        }

        function startGame() {
            document.getElementById("testSection").style.display = "none";
            document.getElementById("instructionSection").style.display = "block";
            
            // åœ¨é€™è£¡é–‹å§‹æ’­æ”¾ç¬¬ä¸€è¼ªéŸ³æ¨‚
            currentRoundMusic = currentMusicSequence[0];
            playMusic(currentRoundMusic);
            
            startPrepTimer();
        }

        function startPrepTimer() {
            let prepTime = 15;
            document.getElementById("prepTimer").innerText = prepTime;
            const prepTimer = setInterval(() => {
                prepTime--;
                document.getElementById("prepTimer").innerText = prepTime;
                if (prepTime <= 0) {
                    clearInterval(prepTimer);
                    startGameAfterPrep(); // ç›´æ¥é–‹å§‹éŠæˆ²
                }
            }, 1000);
        }

        function startGameAfterPrep() {
            document.getElementById("instructionSection").style.display = "none";
            document.getElementById("gameSection").style.display = "block";
            gameRound++;
            
            if (gameRound > 4) {
                showResult();
                return;
            }

            prepareQuestionQueue();
            startTimer();
            showNextQuestion();
        }

        function prepareQuestionQueue() {
            questionQueue = [];
            words.forEach((word, index) => {
                for (let i = 0; i < 5; i++) {
                    questionQueue.push({
                        word: word,
                        colorIndex: Math.floor(Math.random() * colors.length)
                    });
                }
            });
            shuffleArray(questionQueue);
        }

        function showNextQuestion() {
            if (currentQuestion >= 20) {
                clearInterval(timer);
                saveRoundResults();
                if (gameRound < 4) {
                    showBreak();
                } else {
                    showResult();
                }
                return;
            }

            const question = questionQueue[currentQuestion];
            document.getElementById("word").innerText = question.word;
            document.body.style.backgroundColor = colors[question.colorIndex];
            document.getElementById("word").setAttribute("data-correct", 
                words.indexOf(question.word) === question.colorIndex);
            currentQuestion++;
        }

        function checkAnswer(isCorrect) {
            const correct = document.getElementById("word").getAttribute("data-correct") === "true";
            if (isCorrect === correct) {
                const currentCorrect = parseInt(document.getElementById("correct").innerText);
                document.getElementById("correct").innerText = currentCorrect + 1;
            } else {
                const currentWrong = parseInt(document.getElementById("wrong").innerText);
                document.getElementById("wrong").innerText = currentWrong + 1;
            }
        }

        function startTimer() {
            let timeLeft = 20;
            document.getElementById("timer").innerText = timeLeft;
            showNextQuestion(); // é¡¯ç¤ºç¬¬ä¸€é¡Œ

            timer = setInterval(() => {
                timeLeft--;
                document.getElementById("timer").innerText = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    saveRoundResults();
                    if (gameRound < 4) {
                        showBreak();
                    } else {
                        showResult();
                    }
                    return;
                }
                showNextQuestion();
            }, 1000);
        }

        function saveRoundResults() {
            const correct = parseInt(document.getElementById("correct").innerText) || 0;
            const wrong = parseInt(document.getElementById("wrong").innerText) || 0;
            const unanswered = 20 - correct - wrong;
            
            roundResults[gameRound - 1] = {
                round: gameRound,
                correct: correct,
                wrong: wrong + unanswered // å°‡æœªä½œç­”è¨ˆå…¥éŒ¯èª¤æ•¸é‡
            };

            // å„²å­˜å¾Œç«‹å³æ›´æ–°é¡¯ç¤º
            document.getElementById("break-correct").innerText = correct;
            document.getElementById("break-wrong").innerText = wrong + unanswered;
        }

        function showBreak() {
            const currentResult = roundResults[gameRound - 1];
            document.getElementById("gameSection").style.display = "none";
            document.getElementById("breakSection").style.display = "block";
            
            // æ›´æ–°é¡¯ç¤ºçµæœ
            document.getElementById("break-correct").innerText = currentResult.correct;
            document.getElementById("break-wrong").innerText = currentResult.wrong;

            // ç«‹å³åˆ‡æ›åˆ°ä¸‹ä¸€é—œçš„éŸ³æ¨‚
            const nextRoundMusic = currentMusicSequence[gameRound];
            if (nextRoundMusic) {
                Object.values(audioPlayers).forEach(player => {
                    player.pause();
                    player.currentTime = 0;
                });
                
                if (nextRoundMusic !== 'none') {
                    const player = audioPlayers[nextRoundMusic];
                    if (player) {
                        player.currentTime = 0;
                        player.volume = 0.5;
                        player.play();
                    }
                }
            }
            
            let breakTime = 15;
            document.getElementById("break-timer").innerText = breakTime;
            const breakTimer = setInterval(() => {
                breakTime--;
                document.getElementById("break-timer").innerText = breakTime;
                if (breakTime <= 0) {
                    clearInterval(breakTimer);
                    startGameAfterBreak();
                }
            }, 1000);
        }

        function startGameAfterBreak() {
            document.getElementById("breakSection").style.display = "none";
            document.getElementById("gameSection").style.display = "block";
            gameRound++;
            
            if (gameRound > 4) {
                showResult();
                return;
            }

            // é‡ç½®è¨ˆæ•¸å™¨å’Œå•é¡Œ
            document.getElementById("correct").innerText = "0";
            document.getElementById("wrong").innerText = "0";
            currentQuestion = 0;
            
            prepareQuestionQueue();
            startTimer();
        }

        function showResult() {
            document.getElementById("gameSection").style.display = "none";
            document.getElementById("breakSection").style.display = "none";
            document.getElementById("resultSection").style.display = "block";
            
            let roundResultsText = roundResults.map((result, index) => {
                // å–å¾—è©²å›åˆçš„éŸ³æ¨‚é¡å‹
                const musicType = currentMusicSequence[index];
                let musicName = "";
                switch(musicType) {
                    case 'classical':
                        musicName = "å¤å…¸éŸ³æ¨‚";
                        break;
                    case 'jazz':
                        musicName = "çˆµå£«éŸ³æ¨‚";
                        break;
                    case 'indie':
                        musicName = "ç¨ç«‹éŸ³æ¨‚";
                        break;
                    case 'none':
                        musicName = "ç„¡éŸ³æ¨‚";
                        break;
                }
                
                return `<div class="round-result">
                    ${musicName} - æ­£ç¢º: ${result.correct} éŒ¯èª¤: ${result.wrong}
                </div>`;
            }).join('');
            
            document.getElementById("roundResults").innerHTML = roundResultsText;
            
            let bestRound = roundResults.reduce((best, current) => 
                (current.correct > best.correct ? current : best), roundResults[0]);
            
            // é¡¯ç¤ºæœ€ä½³è¡¨ç¾çš„éŸ³æ¨‚é¡å‹
            const bestMusicType = currentMusicSequence[bestRound.round - 1];
            let bestMusicName = "";
            switch(bestMusicType) {
                case 'classical':
                    bestMusicName = "å¤å…¸éŸ³æ¨‚";
                    break;
                case 'jazz':
                    bestMusicName = "çˆµå£«éŸ³æ¨‚";
                    break;
                case 'indie':
                    bestMusicName = "ç¨ç«‹éŸ³æ¨‚";
                    break;
                case 'none':
                    bestMusicName = "ç„¡éŸ³æ¨‚";
                    break;
            }
            
            document.getElementById("bestRound").innerText = bestMusicName;
            bestRoundMusic = currentMusicSequence[bestRound.round - 1];
            playMusic(bestRoundMusic);
        }

        function restartGame() {
            document.getElementById("resultSection").style.display = "none";
            document.getElementById("startButton").style.display = "block";
            document.getElementById("correct").innerText = 0;
            document.getElementById("wrong").innerText = 0;
            document.getElementById("timer").innerText = 30;
            testRound = 0;
            gameRound = 0;
            roundResults = [];
            document.body.style.backgroundColor = '';
            
            if (audioPlayers) {
                Object.values(audioPlayers).forEach(player => {
                    player.pause();
                    player.currentTime = 0;
                });
            }
        }

        window.onload = function() {
            document.getElementById("welcomeSection").style.display = "block";
            document.getElementById("startButton").style.display = "none";
            preloadMusic();
        };

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // æ–°å¢å‡½æ•¸
        function showInstructions() {
            document.getElementById("welcomeSection").style.display = "none";
            document.getElementById("instructionsSection").style.display = "block";
        }

        function startTest() {
            document.getElementById("instructionsSection").style.display = "none";
            document.getElementById("formSection").style.display = "block";
        }
    </script>
</body>
</html>