<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroop Test 專注力測驗</title>
    <style>
        /* 基本樣式 */
        body { 
            font-family: 'Microsoft JhengHei', sans-serif; 
            text-align: center; 
            transition: background-color 0.1s;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }

        #word, #testWord { 
            font-size: 5em; 
            margin: 20px; 
            color: white; 
            font-weight: bold; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        /* 完全隱藏計分板 */
        #scoreboard { 
            display: none !important;
            visibility: hidden;
            position: absolute;
            left: -9999px;
        }

        #gameSection, #formSection, #resultSection, #testSection, #breakSection { 
            display: none; 
        }

        .inline-buttons { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin-top: 30px;
        }

        .center-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 80vh; 
            flex-direction: column; 
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        /* 表單樣式 */
        .form-group {
            margin: 20px 0;
            text-align: left;
            width: 350px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            color: #333;
            background-color: white;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5em;
        }

        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        select:hover {
            border-color: #3498db;
        }

        select.error {
            border-color: #e74c3c;
            background-color: #fff8f8;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
            padding: 5px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            color: #333;
            background-color: white;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-input.error {
            border-color: #e74c3c;
            background-color: #fff8f8;
        }

        /* 按鈕樣式 */
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            /* 移除背景色變化 */
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 遊戲按鈕樣式 - 更大的O/X */
        .game-button {
            background-color: #A0A0A0;
            color: white;
            font-size: 112px; /* 160px的70% */
            padding: 40px 80px;
            margin: 0 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 160px;
            height: 160px;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }

        .game-button:hover {
            background-color: #888888;
            transform: translateY(-2px);
        }

        /* 修改進度條樣式 */
        .progress-bar {
            width: 300px;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin: 20px auto;  /* 改為 auto 實現置中 */
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }

        /* 反饋訊息樣式 */
        .test-feedback {
            padding: 10px 20px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .feedback-correct {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback-wrong {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* 休息區塊樣式 */
        .break-info {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 結果區塊樣式 */
        .result-info {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: left;
        }

        .round-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid #4CAF50;
        }

        /* 更新音頻控制樣式 */
        .audio-control {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        /* 開始按鈕置中 */
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            padding: 20px 40px;
        }

        /* 色彩辨識測驗樣式 */
        .color-test {
            display: none;
            text-align: center;
        }

        .color-button {
            font-size: 24px;
            margin: 10px;
            padding: 15px 30px;
        }

        /* 色塊樣式 */
        .color-block {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            margin: 10px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* 遊戲說明樣式更新 */
        .instruction-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 20px auto;
        }

        .instruction-content ul {
            text-align: left;
            padding-left: 20px;
        }

        .instruction-content li {
            margin: 15px 0;
            position: relative;
            padding-left: 25px;
        }

        .instruction-content li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #4CAF50;
        }

        .prep-timer {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: inline-block;
        }

        /* 色彩辨識測驗樣式更新 */
        .color-answer-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 400px;
            margin: 30px auto;
        }

        .color-answer-button {
            font-size: 24px;
            padding: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-answer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* 新增顏色按鈕樣式 */
        .btn-red { background-color: #D98880; }
        .btn-blue { background-color: #85C1E9; }
        .btn-green { background-color: #A9DFBF; }
        .btn-yellow { background-color: #F7DC6F; }

        /* 新增樣式 */
        .welcome-content, .instructions-content {
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            line-height: 1.6;
            padding: 20px;
        }

        .section-block {
            margin: 25px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .highlight {
            font-size: 1.2em;
            color: #2c3e50;
            font-weight: bold;
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .privacy-notice {
            color: #666;
            font-style: italic;
            margin-bottom: 20px;
        }

        .next-button {
            margin: 20px auto;
            display: block;
        }
    </style>
</head>

<body>
    <h1>Stroop Test 專注力測驗</h1>
    
    <button id="startButton" onclick="showForm()">開始測試</button>

    <!-- 修改歡迎頁面內容 -->
    <div id="welcomeSection" class="center-container">
        <h1>🎯 歡迎參加《音樂與專注力測驗》</h1>
        <div class="welcome-content">
            <p>大家好，我們是臺灣師範大學音樂系的同學！</p>
            <p>由於課堂作業需求，</p>
            <p>我們正在探討背景音樂對於人們專注力的影響，</p>
            <p>於是開啟了一個小研究。希望大家能填答以下問題及體驗小遊戲（記得打開聲音喔🔊），謝謝🙏</p>
            <button onclick="showInstructions()" class="next-button">下一頁</button>
        </div>
    </div>

    <!-- 更新說明頁面符號 -->
    <div id="instructionsSection" class="center-container" style="display: none;">
        <h2>🧪 測驗方式說明</h2>
        <div class="instructions-content">
            <p>這是一個根據「Stroop Effect（史楚普效應）」設計的網頁遊戲。</p>
            <p>畫面中會出現一個中文字（如「紅」「綠」「藍」等）搭配一種背景顏色，<br>您的任務是判斷：</p>
            <p class="highlight">文字的意思 是否與 顏色背景 相符？</p>
            <p>並在1秒內點選「O」或「X」作答。</p>
            
            <div class="section-block">
                <h3>🎧 測驗包含四個不同背景音樂情境：</h3>
                <ul>
                    <li>無音樂</li>
                    <li>古典音樂（Mozart）</li>
                    <li>爵士音樂（Miles Davis）</li>
                    <li>獨立音樂（Deftones）</li>
                </ul>
            </div>
            
            <p>• 每一關進行 20 秒，每關之間會有 15 秒休息時間<br>
               • 系統會隨機播放音樂情境，每秒出現一道題目<br>
               • 請盡量準確、快速地作答！</p>
            
            <button onclick="startTest()" class="next-button">開始測驗</button>
        </div>
    </div>

    <!-- 更新色彩辨識測驗區塊 -->
    <div id="colorTest" class="center-container" style="display: none;">
        <h2>色彩辨識測驗</h2>
        <p>請選擇與文字相符的顏色按鈕：</p>
        <div id="colorTestWord" style="font-size: 5em; margin: 30px; font-weight: bold; color: black;">紅</div>
        <div class="color-answer-buttons">
            <button class="color-answer-button btn-red" onclick="checkColorAnswer('red')"></button>
            <button class="color-answer-button btn-blue" onclick="checkColorAnswer('blue')"></button>
            <button class="color-answer-button btn-green" onclick="checkColorAnswer('green')"></button>
            <button class="color-answer-button btn-yellow" onclick="checkColorAnswer('yellow')"></button>
        </div>
        <p id="colorTestFeedback"></p>
        <div class="progress-bar">
            <div class="progress" style="width: 0%"></div>
        </div>
    </div>

    <!-- 表單區塊 -->
    <div id="formSection" class="center-container" style="display: none;">
        <h2 class="form-title">基本資料填寫</h2>
        <p class="privacy-notice">您所提供的資料僅供研究使用，不會揭露個人身份，請放心填寫。</p>
        
        <div class="form-group">
            <label for="name">姓名:</label>
            <input type="text" id="name" class="form-input">
            <div class="error-message">請輸入姓名</div>
        </div>

        <div class="form-group">
            <label for="musicMajor">系級:</label>
            <select id="musicMajor">
                <option value="">--請選擇--</option>
                <option value="music">音樂系</option>
                <option value="non-music">非音樂系</option>
            </select>
            <div class="error-message">請選擇您的科系類別</div>
        </div>

        <div class="form-group">
            <label for="grade">學制:</label>
            <select id="grade">
                <option value="">--請選擇--</option>
                <option value="undergraduate">大學生</option>
                <option value="graduate">研究生</option>
            </select>
            <div class="error-message">請選擇您的學制</div>
        </div>

        <div class="form-group">
            <label for="musicListeningHabit">工作/讀書時聆聽音樂習慣:</label>
            <select id="musicListeningHabit">
                <option value="">--請選擇--</option>
                <option value="always">總是</option>
                <option value="often">經常</option>
                <option value="sometimes">偶爾</option>
                <option value="rarely">很少</option>
                <option value="never">無</option>
            </select>
            <div class="error-message">請選擇您的聆聽音樂習慣</div>
        </div>

        <button onclick="submitForm()">下一步</button>
    </div>

    <!-- 測試區塊 -->
    <div id="testSection" class="center-container">
        <h2>測試階段</h2>
        <div class="progress-bar">
            <div class="progress" style="width: 0%"></div>
        </div>
        <p>請判斷文字與背景顏色是否匹配</p>
        <div id="testContainer">
            <div id="testWord">顏色</div>
            <div class="inline-buttons">
                <button class="game-button" onclick="checkTestAnswer(true)">O</button>
                <button class="game-button" onclick="checkTestAnswer(false)">X</button>
            </div>
        </div>
        <p id="testFeedback"></p>
        <button id="startGameButton" style="display:none;" onclick="startGame()">進入遊戲</button>
    </div>

    <!-- 遊戲說明頁面 -->
    <div id="instructionSection" class="center-container" style="display: none;">
        <h2>遊戲說明</h2>
        <div class="instruction-content">
            <p>遊戲規則：</p>
            <ul>
                <li>每回合共有20題，每題顯示1秒</li>
                <li>若題目文字顏色與背景顏色相符，請按 O</li>
                <li>若題目文字顏色與背景顏色不相符，請按 X</li>
                <li>每個顏色會出現5次</li>
                <li>答題時間為20秒</li>
                <li>每回合間休息時間為15秒</li>
            </ul>
            <div class="prep-timer">
                準備時間：<span id="prepTimer">15</span> 秒
            </div>
        </div>
        <button onclick="startGameAfterPrep()" style="display: none;" id="startAfterPrepButton">開始遊戲</button>
    </div>

    <!-- 遊戲區塊 -->
    <div id="gameSection" class="center-container">
        <div id="word">顏色</div>
        <div class="inline-buttons">
            <button class="game-button" onclick="checkAnswer(true)">O</button>
            <button class="game-button" onclick="checkAnswer(false)">X</button>
        </div>
        <div id="scoreboard">
            <p>正確數量: <span id="correct">0</span></p>
            <p>錯誤數量: <span id="wrong">0</span></p>
            <p>剩餘時間: <span id="timer">30</span> 秒</p>
        </div>
    </div>

    <!-- 修改休息區塊 -->
    <div id="breakSection" class="center-container">
        <h2>休息時間</h2>
        <div class="break-info">
            <p>本回合測試結果：</p>
            <p>正確: <span id="break-correct">0</span> 次</p>
            <p>錯誤: <span id="break-wrong">0</span> 次</p>
            <p>15秒後將自動進入下一回合，請保持專注。</p>
            <p>回合間的休息時間確保每位參與者聽到相同段落的音樂。</p>
            <p>休息剩餘時間：<span id="break-timer">15</span> 秒</p>
        </div>
    </div>

    <!-- 修改結果區塊中的最佳回合顯示 -->
    <div id="resultSection" class="center-container">
        <h2>測試結果</h2>
        <div class="result-info">
            <p id="roundResults"></p>
            <p>最佳回合: <span id="bestRound">古典音樂</span> 回合</p>
        </div>
        <button onclick="restartGame()">重新開始</button>
    </div>

    <script>
        let words = ["紅", "藍", "綠", "黃"];
        let colors = ["#D98880", "#85C1E9", "#A9DFBF", "#F7DC6F"];
        let testRound = 0;
        let gameRound = 0;
        let timer;
        let roundResults = [];
        let musicPreference = '';
        let currentColorTest = 0;
        let colorTestSequence = ['red', 'blue', 'green', 'yellow'];
        let questionQueue = [];
        let currentQuestion = 0;

        // 音樂播放順序設定
        const musicSequences = {
            'always': ['jazz', 'classical', 'none', 'indie'],
            'often': ['classical', 'jazz', 'none', 'indie'],
            'sometimes': ['indie', 'jazz', 'none', 'classical'],
            'rarely': ['indie', 'classical', 'none', 'jazz'],
            'never': ['classical', 'indie', 'none', 'jazz']
        };

        // 音樂資料設定
        const musicData = {
            'jazz': {
                url: 'jazz.mp3'
            },
            'classical': {
                url: 'classical.mp3'
            },
            'indie': {
                url: 'indie.mp3'
            }
        };

        let audioPlayers = {};

        // 預加載音樂
        function preloadMusic() {
            for (const [type, data] of Object.entries(musicData)) {
                audioPlayers[type] = new Audio(data.url);
                audioPlayers[type].load();
                audioPlayers[type].loop = true;
            }
        }

        // 播放音樂
        function playMusic(musicType) {
            // 停止所有其他音樂
            Object.values(audioPlayers).forEach(player => {
                player.pause();
                player.currentTime = 0;
            });
            
            if (musicType === 'none') return;
            
            const player = audioPlayers[musicType];
            if (player) {
                player.currentTime = 0; // 從頭開始播放
                player.volume = 0.5; // 設定音量為 50%
                try {
                    const playPromise = player.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log('播放失敗:', error);
                        });
                    }
                } catch (error) {
                    console.log('播放出錯:', error);
                }
            }
        }

        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        function showForm() {
            document.getElementById("startButton").style.display = "none";
            document.getElementById("formSection").style.display = "block";
        }

        function submitForm() {
            const formFields = [
                { id: "name", label: "姓名" },
                { id: "musicMajor", label: "系級" },
                { id: "grade", label: "學制" },
                { id: "musicListeningHabit", label: "工作/讀書時聆聽音樂習慣" }
            ];

            let isValid = true;

            formFields.forEach(item => {
                const element = document.getElementById(item.id);
                const errorMessage = element.nextElementSibling;
                
                if (!element.value) {
                    isValid = false;
                    element.classList.add('error');
                    errorMessage.style.display = 'block';
                } else {
                    element.classList.remove('error');
                    errorMessage.style.display = 'none';
                }
            });

            if (!isValid) return;

            // 移除音樂播放
            const musicHabit = document.getElementById("musicListeningHabit").value;
            currentMusicSequence = [...musicSequences[musicHabit]];
            
            document.getElementById("formSection").style.display = "none";
            document.getElementById("colorTest").style.display = "block";
            currentColorQuestion = 0;
            showNextColorQuestion();
        }

        // 更新色彩辨識測驗相關函數
        let colorTestWords = ["紅", "藍", "綠", "黃"];
        let currentColorQuestion = 0;

        function showNextColorQuestion() {
            const word = colorTestWords[currentColorQuestion];
            const testWord = document.getElementById("colorTestWord");
            testWord.innerText = word;
            
            // 更新進度條
            const progress = (currentColorQuestion / colorTestWords.length) * 100;
            document.querySelector('#colorTest .progress').style.width = `${progress}%`;
        }

        function checkColorAnswer(selectedColor) {
            const currentWord = colorTestWords[currentColorQuestion];
            const isCorrect = (
                (selectedColor === 'red' && currentWord === "紅") ||
                (selectedColor === 'blue' && currentWord === "藍") ||
                (selectedColor === 'green' && currentWord === "綠") ||
                (selectedColor === 'yellow' && currentWord === "黃")
            );

            const feedback = document.getElementById('colorTestFeedback');
            
            if (isCorrect) {
                feedback.innerText = "答對了！";
                feedback.className = "test-feedback feedback-correct";
                currentColorQuestion++;
                
                if (currentColorQuestion >= colorTestWords.length) {
                    setTimeout(() => {
                        document.getElementById("colorTest").style.display = "none";
                        document.getElementById("testSection").style.display = "block";
                        showTestWord();
                    }, 1000);
                    return;
                }

                setTimeout(() => {
                    feedback.innerText = "";
                    showNextColorQuestion();
                }, 1000);
            } else {
                feedback.innerText = "答錯了，請再試一次";
                feedback.className = "test-feedback feedback-wrong";
            }
        }

        function showTestWord() {
            const progressBar = document.querySelector('.progress');
            const progressPercent = (testRound / 3) * 100;
            progressBar.style.width = `${progressPercent}%`;

            if (testRound >= 3) {
                document.getElementById("testFeedback").innerText = "測試已完成";
                document.getElementById("testFeedback").className = "test-feedback feedback-correct";
                document.getElementById("startGameButton").style.display = "block";
                return;
            }

            let wordIndex = getRandomInt(words.length);
            let colorIndex = getRandomInt(colors.length);
            
            if (testRound === 0) {
                wordIndex = colorIndex;
            } else if (testRound === 1) {
                wordIndex = (colorIndex + 1) % colors.length;
            }
            
            document.getElementById("testWord").innerText = words[wordIndex];
            document.body.style.backgroundColor = colors[colorIndex];
            document.getElementById("testWord").setAttribute("data-correct", wordIndex === colorIndex);
        }

        function checkTestAnswer(userChoice) {
            let correct = document.getElementById("testWord").getAttribute("data-correct") === "true";
            let feedback = document.getElementById("testFeedback");
            
            if (userChoice === correct) {
                feedback.innerText = "答對了！";
                feedback.className = "test-feedback feedback-correct";
            } else {
                feedback.innerText = "答錯了！正確答案是" + (correct ? "匹配" : "不匹配");
                feedback.className = "test-feedback feedback-wrong";
            }

            testRound++;
            
            const progressBar = document.querySelector('.progress');
            const progressPercent = (testRound / 3) * 100;
            progressBar.style.width = `${progressPercent}%`;

            if (testRound < 3) {
                setTimeout(() => {
                    feedback.innerText = `準備第 ${testRound + 1} 題...`;
                    feedback.className = "test-feedback";
                    setTimeout(showTestWord, 1000);
                }, 1500);
            } else {
                setTimeout(() => {
                    feedback.innerText = "測試完成！您可以開始正式遊戲了";
                    feedback.className = "test-feedback feedback-correct";
                    document.getElementById("startGameButton").style.display = "block";
                }, 1500);
            }
        }

        function startGame() {
            document.getElementById("testSection").style.display = "none";
            document.getElementById("instructionSection").style.display = "block";
            
            // 在這裡開始播放第一輪音樂
            currentRoundMusic = currentMusicSequence[0];
            playMusic(currentRoundMusic);
            
            startPrepTimer();
        }

        function startPrepTimer() {
            let prepTime = 15;
            document.getElementById("prepTimer").innerText = prepTime;
            const prepTimer = setInterval(() => {
                prepTime--;
                document.getElementById("prepTimer").innerText = prepTime;
                if (prepTime <= 0) {
                    clearInterval(prepTimer);
                    startGameAfterPrep(); // 直接開始遊戲
                }
            }, 1000);
        }

        function startGameAfterPrep() {
            document.getElementById("instructionSection").style.display = "none";
            document.getElementById("gameSection").style.display = "block";
            gameRound++;
            
            if (gameRound > 4) {
                showResult();
                return;
            }

            prepareQuestionQueue();
            startTimer();
            showNextQuestion();
        }

        function prepareQuestionQueue() {
            questionQueue = [];
            words.forEach((word, index) => {
                for (let i = 0; i < 5; i++) {
                    questionQueue.push({
                        word: word,
                        colorIndex: Math.floor(Math.random() * colors.length)
                    });
                }
            });
            shuffleArray(questionQueue);
        }

        function showNextQuestion() {
            if (currentQuestion >= 20) {
                clearInterval(timer);
                saveRoundResults();
                if (gameRound < 4) {
                    showBreak();
                } else {
                    showResult();
                }
                return;
            }

            const question = questionQueue[currentQuestion];
            document.getElementById("word").innerText = question.word;
            document.body.style.backgroundColor = colors[question.colorIndex];
            document.getElementById("word").setAttribute("data-correct", 
                words.indexOf(question.word) === question.colorIndex);
            currentQuestion++;
        }

        function checkAnswer(isCorrect) {
            const correct = document.getElementById("word").getAttribute("data-correct") === "true";
            if (isCorrect === correct) {
                const currentCorrect = parseInt(document.getElementById("correct").innerText);
                document.getElementById("correct").innerText = currentCorrect + 1;
            } else {
                const currentWrong = parseInt(document.getElementById("wrong").innerText);
                document.getElementById("wrong").innerText = currentWrong + 1;
            }
        }

        function startTimer() {
            let timeLeft = 20;
            document.getElementById("timer").innerText = timeLeft;
            showNextQuestion(); // 顯示第一題

            timer = setInterval(() => {
                timeLeft--;
                document.getElementById("timer").innerText = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    saveRoundResults();
                    if (gameRound < 4) {
                        showBreak();
                    } else {
                        showResult();
                    }
                    return;
                }
                showNextQuestion();
            }, 1000);
        }

        function saveRoundResults() {
            const correct = parseInt(document.getElementById("correct").innerText) || 0;
            const wrong = parseInt(document.getElementById("wrong").innerText) || 0;
            const unanswered = 20 - correct - wrong;
            
            roundResults[gameRound - 1] = {
                round: gameRound,
                correct: correct,
                wrong: wrong + unanswered // 將未作答計入錯誤數量
            };

            // 儲存後立即更新顯示
            document.getElementById("break-correct").innerText = correct;
            document.getElementById("break-wrong").innerText = wrong + unanswered;
        }

        function showBreak() {
            const currentResult = roundResults[gameRound - 1];
            document.getElementById("gameSection").style.display = "none";
            document.getElementById("breakSection").style.display = "block";
            
            // 更新顯示結果
            document.getElementById("break-correct").innerText = currentResult.correct;
            document.getElementById("break-wrong").innerText = currentResult.wrong;

            // 立即切換到下一關的音樂
            const nextRoundMusic = currentMusicSequence[gameRound];
            if (nextRoundMusic) {
                Object.values(audioPlayers).forEach(player => {
                    player.pause();
                    player.currentTime = 0;
                });
                
                if (nextRoundMusic !== 'none') {
                    const player = audioPlayers[nextRoundMusic];
                    if (player) {
                        player.currentTime = 0;
                        player.volume = 0.5;
                        player.play();
                    }
                }
            }
            
            let breakTime = 15;
            document.getElementById("break-timer").innerText = breakTime;
            const breakTimer = setInterval(() => {
                breakTime--;
                document.getElementById("break-timer").innerText = breakTime;
                if (breakTime <= 0) {
                    clearInterval(breakTimer);
                    startGameAfterBreak();
                }
            }, 1000);
        }

        function startGameAfterBreak() {
            document.getElementById("breakSection").style.display = "none";
            document.getElementById("gameSection").style.display = "block";
            gameRound++;
            
            if (gameRound > 4) {
                showResult();
                return;
            }

            // 重置計數器和問題
            document.getElementById("correct").innerText = "0";
            document.getElementById("wrong").innerText = "0";
            currentQuestion = 0;
            
            prepareQuestionQueue();
            startTimer();
        }

        function showResult() {
            document.getElementById("gameSection").style.display = "none";
            document.getElementById("breakSection").style.display = "none";
            document.getElementById("resultSection").style.display = "block";
            
            let roundResultsText = roundResults.map((result, index) => {
                // 取得該回合的音樂類型
                const musicType = currentMusicSequence[index];
                let musicName = "";
                switch(musicType) {
                    case 'classical':
                        musicName = "古典音樂";
                        break;
                    case 'jazz':
                        musicName = "爵士音樂";
                        break;
                    case 'indie':
                        musicName = "獨立音樂";
                        break;
                    case 'none':
                        musicName = "無音樂";
                        break;
                }
                
                return `<div class="round-result">
                    ${musicName} - 正確: ${result.correct} 錯誤: ${result.wrong}
                </div>`;
            }).join('');
            
            document.getElementById("roundResults").innerHTML = roundResultsText;
            
            let bestRound = roundResults.reduce((best, current) => 
                (current.correct > best.correct ? current : best), roundResults[0]);
            
            // 顯示最佳表現的音樂類型
            const bestMusicType = currentMusicSequence[bestRound.round - 1];
            let bestMusicName = "";
            switch(bestMusicType) {
                case 'classical':
                    bestMusicName = "古典音樂";
                    break;
                case 'jazz':
                    bestMusicName = "爵士音樂";
                    break;
                case 'indie':
                    bestMusicName = "獨立音樂";
                    break;
                case 'none':
                    bestMusicName = "無音樂";
                    break;
            }
            
            document.getElementById("bestRound").innerText = bestMusicName;
            bestRoundMusic = currentMusicSequence[bestRound.round - 1];
            playMusic(bestRoundMusic);
        }

        function restartGame() {
            document.getElementById("resultSection").style.display = "none";
            document.getElementById("startButton").style.display = "block";
            document.getElementById("correct").innerText = 0;
            document.getElementById("wrong").innerText = 0;
            document.getElementById("timer").innerText = 30;
            testRound = 0;
            gameRound = 0;
            roundResults = [];
            document.body.style.backgroundColor = '';
            
            if (audioPlayers) {
                Object.values(audioPlayers).forEach(player => {
                    player.pause();
                    player.currentTime = 0;
                });
            }
        }

        window.onload = function() {
            document.getElementById("welcomeSection").style.display = "block";
            document.getElementById("startButton").style.display = "none";
            preloadMusic();
        };

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 新增函數
        function showInstructions() {
            document.getElementById("welcomeSection").style.display = "none";
            document.getElementById("instructionsSection").style.display = "block";
        }

        function startTest() {
            document.getElementById("instructionsSection").style.display = "none";
            document.getElementById("formSection").style.display = "block";
        }
    </script>
</body>
</html>